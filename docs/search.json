[
  {
    "objectID": "orthos.html",
    "href": "orthos.html",
    "title": "LGLN opendata in R",
    "section": "",
    "text": "Let’s load some basic libraries to work with the data\n\nrenv::restore()\nlibrary(here)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(terra)\nlibrary(vapour)\n\n\n\n\nThe data catalog is basically a geojson file which is stored in a cloud bucket. It consists of many polygons which cover cover Lower Saxony and represent image tiles (2x2 km). For each tile it contains some basic metadata and links to further metadata of the images and links to the image data itself.\nLet’s load the data in R.\n\ndat <- sf::st_read(\"https://single-datasets.opengeodata.lgln.niedersachsen.de/pro-download-indices/dop/lgln-opengeodata-dop20.geojson\")\n\nReading layer `lgln-opengeodata-dop20' from data source \n  `https://single-datasets.opengeodata.lgln.niedersachsen.de/pro-download-indices/dop/lgln-opengeodata-dop20.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 21763 features and 6 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 342000 ymin: 5682000 xmax: 676000 ymax: 5972000\nProjected CRS: ETRS89 / UTM zone 32N\n\n\nand print the first object (tile) to get an ideas of the data.\n\nprint(dat[1,])\n\nSimple feature collection with 1 feature and 6 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 342000 ymin: 5940000 xmax: 344000 ymax: 5942000\nProjected CRS: ETRS89 / UTM zone 32N\n  Aktualitaet\n1  2020-04-18\n                                                                                                                rgb\n1 https://dop20-rgb.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgb_32_342_5940_2_ni_2020-04-18.tif\n                                                                                                       rgb_metadata\n1 https://dop20-rgb.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgb_32_342_5940_2_ni_2020-04-18.xml\n                                                                                                                 rgbi\n1 https://dop20-rgbi.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgbi_32_342_5940_2_ni_2020-04-18.tif\n                                                                                                        rgbi_metadata\n1 https://dop20-rgbi.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgbi_32_342_5940_2_ni_2020-04-18.xml\n    tile_id                       geometry\n1 323425940 POLYGON ((342000 5940000, 3...\n\n\nwe can optionally preprocess the data, here we change the date format\n\ndat$date <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%Y%m%d\")\ndat$year <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%Y\")\ndat$month_day <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%m%d\")\ndat$doy <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%j\")\n\n\n\n\nAs we have seen above, the data catalog contains information about the acquisition date of images. We can plot this data to get more information about the available images.\n\n\n\ndat |> \n  arrange(date) |> \n  \n  ggplot() + \n  geom_sf( aes(fill = year), color = NA) + \n  theme_void()  +\n  scale_fill_viridis_d(option = \"plasma\")\n\n\n\n\nFigure 1: Latest acquisition date per tile\n\n\n\n\n\n\n\n\ndat |>  \n  arrange(date) |> \n  \n  ggplot() + \n  geom_sf( aes(fill = as.integer(doy)), color = NA) + \n  theme_void()  +\n  scale_fill_viridis_c(option = \"plasma\")\n\n# interactive mapping\n\n# dat |> \n#   arrange(date) |>  \n#   mapview::mapview(zcol=\"doy\")\n\n\n\n\nFigure 2: Acquisition date within year\n\n\n\n\n\n\n\n\nFinally we can also query the image data itself. As we have seen above the data catalog contains links to the images. For each tile there is two different image versions per date: rgb-images are 3-band images compressed as jpeg and primarily meant to display; rgbi-images are lossless compressed and contain the NIR-channel, they can be used for analytical work. The images are stored in a cloud bucket as Cloud Optimized Geotiffs (COG), this means that the image data contains image overviews and is structured internally in such a way that it is possible to stream only the required image data. This makes it quite efficient and comfortable to work with the image data.\n\n\nHere we sort the metadata catalog in descending order by acquisition date and get the first rgb-image link. We then load and plot the data.\n\nfileadress =\n  dat |> \n  arrange(desc(date)) |> \n  slice(1) |> \n  pull(rgb)\n\ncog.url <- paste0(\"/vsicurl/\", fileadress)\nras <- terra::rast(cog.url)\n\nterra::plotRGB(ras)\n\n\n\n\nFigure 3: Latest acquired image\n\n\n\n\n\n\n\nHere we sort the metadata catalog in ascending order by acquisition date and get the first rgbi-image link. We then load and plot the data as false color composite.\n\nfileadress =\n  dat |> \n  arrange(date) |> \n  slice(1) |> \n  pull(rgbi)\n\ncog.url <- paste0(\"/vsicurl/\", fileadress)\nras <- terra::rast(cog.url)\n\n\nterra::plotRGB(ras, r=4,g=3,b=2)\n\n\n\n\nFigure 4: First acquired image in false color\n\n\n\n\n\n\n\nAs mentioned before we can access just the data we need from COGs, this means we can query a certain extent or query the image with certain dimensions. In the examples above we plotted the overview, but in order to access the raw data we need some function in R. We create this function here with the vapor package which is able to warp the underlying raw data.\n\nget_img <- function(img, dim = c(500,500)){\n  \n  fileadress <- img |> \n    pull(rgb)  \n  \n  cog.url <- file.path(\"/vsicurl\", fileadress)\n  info <- vapour::vapour_raster_info(cog.url)\n  roi <- info$extent\n  prj <- info$projection\n  dim <-  dim\n\n  vals <- vapour::vapour_warp_raster(cog.url, extent = roi, dimension = dim, projection = prj\n                                   , bands = c(1,2,3)\n                                   , band_output_type = \"Int32\"\n                                   , resample = \"Bilinear\")\n  \n  ras <- terra::rast(terra::ext(roi), ncols = dim[1], nrows = dim[2], vals = array(unlist(vals), c(dim, 3)), nlyrs = 3, crs = prj)\n\n  return(ras)\n}\n\nLets get all images for a certain tile and print the acquisition dates.\n\nmultitemporal <- dat |> \n  filter(tile_id == \"324965790\")\n\nmultitemporal$Aktualitaet\n\n[1] \"2019-04-07\" \"2022-05-03\"\n\n\n\n\n\nNow lets query and print the first image for this tile.\n\nimg1 <- multitemporal |> \n  slice_min(order_by = date) |> \n  get_img()\n\nterra::plotRGB(img1)\n\n\n\n\nFigure 5: First image in tile\n\n\n\n\n\n\n\nAnd the last image for this tile.\n\nimg2 <- multitemporal |> \n  slice_max(order_by = date) |> \n  get_img()\n\nterra::plotRGB(img2)\n\n\n\n\nFigure 6: Last image in tile\n\n\n\n\n\n\n\n\n\n\nWarning\n\n\n\nUntil now you will get a warning Range downloading not supported by this server! when trying to use range requests for RGBI data!"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "LGLN opendata in R",
    "section": "",
    "text": "The State Office for Geoinformation and Land Surveying Lower Saxony (LGLN) provides some of its geodata as open data.\nSince recently they provide ortho images of Lower Saxony for the last years as Cloud Optimized GeoTIFFs. Here we try to access the data via R to explore, vizualize and work with the imagery.\nMore information under opengeodata.lgln.niedersachsen.de."
  },
  {
    "objectID": "sentinel.html",
    "href": "sentinel.html",
    "title": "LGLN opendata in R",
    "section": "",
    "text": "Let’s load some basic libraries to work with the data\n\nrenv::restore()\nlibrary(here)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(terra)\nlibrary(vapour)\n\n\n\n\nFirst we query and plot all Sentinel tiles covering Germany.\n\ndat <- sf::st_read('https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/DE_S2.geojson')\n\nReading layer `DE_S2' from data source \n  `https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/DE_S2.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 69 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 174139.8 ymin: 5190240 xmax: 1035431 ymax: 6200040\nProjected CRS: WGS 84 / UTM zone 32N\n\ndat |> \n  ggplot() + \n  geom_sf(colour = \"black\", fill = NA) + \n  theme_void()\n\n\n\n\n\n\n\n\ndat <- sf::st_read('https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/BE8_in_NI.geojson')\n\nReading layer `BE8_in_NI' from data source \n  `https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/BE8_in_NI.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 965 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 324000 ymin: 5680000 xmax: 676000 ymax: 5992000\nProjected CRS: WGS 84 / UTM zone 32N\n\ndat |> \n  ggplot() + \n  geom_sf() + \n  theme_void()"
  },
  {
    "objectID": "other.html",
    "href": "other.html",
    "title": "LGLN opendata in R",
    "section": "",
    "text": "Let’s load some basic libraries to work with the data\n\nrenv::restore()\nlibrary(here)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(terra)\nlibrary(vapour)\n\n\n\n\n\ndat <- sf::st_read('https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/NI.geojson')\n\nReading layer `NI' from data source \n  `https://cloud.code-de.org:8080/swift/v1/AUTH_622a231224cb46c6982643e55e817c98/geojson/NI.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 45 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 342771.5 ymin: 5682893 xmax: 674214.6 ymax: 5971585\nProjected CRS: WGS 84 / UTM zone 32N\n\ndat |> \n  ggplot() + \n  geom_sf() + \n  theme_void()"
  }
]