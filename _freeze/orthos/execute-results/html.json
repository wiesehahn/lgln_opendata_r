{
  "hash": "46afac0c94dd6c9f7e8f37ac7edca274",
  "result": {
    "markdown": "## Working with Orthoimagery\n\n### Load necessary libraries\n\nLet's load some basic libraries to work with the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrenv::restore()\nlibrary(here)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(terra)\nlibrary(vapour)\n```\n:::\n\n\n### Initialize metadata catalog\n\nThe data catalog is basically a geojson file which is stored in a cloud bucket. It consists of many polygons which cover cover Lower Saxony and represent image tiles (2x2 km). For each tile it contains some basic metadata and links to further metadata of the images and links to the image data itself.\n\nLet's load the data in R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- sf::st_read(\"https://single-datasets.opengeodata.lgln.niedersachsen.de/pro-download-indices/dop/lgln-opengeodata-dop20.geojson\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `lgln-opengeodata-dop20' from data source \n  `https://single-datasets.opengeodata.lgln.niedersachsen.de/pro-download-indices/dop/lgln-opengeodata-dop20.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 21763 features and 6 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 342000 ymin: 5682000 xmax: 676000 ymax: 5972000\nProjected CRS: ETRS89 / UTM zone 32N\n```\n:::\n:::\n\n\nand print the first object (tile) to get an ideas of the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(dat[1,])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 1 feature and 6 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 342000 ymin: 5940000 xmax: 344000 ymax: 5942000\nProjected CRS: ETRS89 / UTM zone 32N\n  Aktualitaet\n1  2020-04-18\n                                                                                                                rgb\n1 https://dop20-rgb.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgb_32_342_5940_2_ni_2020-04-18.tif\n                                                                                                       rgb_metadata\n1 https://dop20-rgb.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgb_32_342_5940_2_ni_2020-04-18.xml\n                                                                                                                 rgbi\n1 https://dop20-rgbi.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgbi_32_342_5940_2_ni_2020-04-18.tif\n                                                                                                        rgbi_metadata\n1 https://dop20-rgbi.opengeodata.lgln.niedersachsen.de/323425940/2020-04-18/dop20rgbi_32_342_5940_2_ni_2020-04-18.xml\n    tile_id                       geometry\n1 323425940 POLYGON ((342000 5940000, 3...\n```\n:::\n:::\n\n\nwe can optionally preprocess the data, here we change the date format\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat$date <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%Y%m%d\")\ndat$year <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%Y\")\ndat$month_day <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%m%d\")\ndat$doy <- format(as.Date(as.character(dat$Aktualitaet), format = \"%Y-%m-%d\"), format= \"%j\")\n```\n:::\n\n\n### Plot metadata catalog\n\nAs we have seen above, the data catalog contains information about the acquisition date of images. We can plot this data to get more information about the available images.\n\n#### Latest acquisition date per tile\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |> \n  arrange(date) |> \n  \n  ggplot() + \n  geom_sf( aes(fill = year), color = NA) + \n  theme_void()  +\n  scale_fill_viridis_d(option = \"plasma\")\n```\n\n::: {.cell-output-display}\n![Latest acquisition date per tile](orthos_files/figure-html/fig-date-latest-1.png){#fig-date-latest width=672}\n:::\n:::\n\n\n#### Acquisition date within the years\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |>  \n  arrange(date) |> \n  \n  ggplot() + \n  geom_sf( aes(fill = as.integer(doy)), color = NA) + \n  theme_void()  +\n  scale_fill_viridis_c(option = \"plasma\")\n\n# interactive mapping\n\n# dat |> \n#   arrange(date) |>  \n#   mapview::mapview(zcol=\"doy\")\n```\n\n::: {.cell-output-display}\n![Acquisition date within year](orthos_files/figure-html/fig-date-doy-1.png){#fig-date-doy width=672}\n:::\n:::\n\n\n### Plot image data\n\nFinally we can also query the image data itself. As we have seen above the data catalog contains links to the images. For each tile there is two different image versions per date: *rgb-images* are 3-band images compressed as jpeg and primarily meant to display; *rgbi-images* are lossless compressed and contain the NIR-channel, they can be used for analytical work. The images are stored in a cloud bucket as Cloud Optimized Geotiffs (COG), this means that the image data contains image overviews and is structured internally in such a way that it is possible to stream only the required image data. This makes it quite efficient and comfortable to work with the image data.\n\n#### Latest image\n\nHere we sort the metadata catalog in descending order by acquisition date and get the first rgb-image link. We then load and plot the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfileadress =\n  dat |> \n  arrange(desc(date)) |> \n  slice(1) |> \n  pull(rgb)\n\ncog.url <- paste0(\"/vsicurl/\", fileadress)\nras <- terra::rast(cog.url)\n\nterra::plotRGB(ras)\n```\n\n::: {.cell-output-display}\n![Latest acquired image](orthos_files/figure-html/fig-latest-image-1.png){#fig-latest-image width=672}\n:::\n:::\n\n\n#### First image\n\nHere we sort the metadata catalog in ascending order by acquisition date and get the first rgbi-image link. We then load and plot the data as false color composite.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfileadress =\n  dat |> \n  arrange(date) |> \n  slice(1) |> \n  pull(rgbi)\n\ncog.url <- paste0(\"/vsicurl/\", fileadress)\nras <- terra::rast(cog.url)\n\n\nterra::plotRGB(ras, r=4,g=3,b=2)\n```\n\n::: {.cell-output-display}\n![First acquired image in false color](orthos_files/figure-html/fig-first-image-1.png){#fig-first-image width=672}\n:::\n:::\n\n\n#### Multi-temporal\n\nAs mentioned before we can access just the data we need from COGs, this means we can query a certain extent or query the image with certain dimensions. In the examples above we plotted the overview, but in order to access the raw data we need some function in R. We create this function here with the vapor package which is able to warp the underlying raw data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_img <- function(img, dim = c(500,500)){\n  \n  fileadress <- img |> \n    pull(rgb)  \n  \n  cog.url <- file.path(\"/vsicurl\", fileadress)\n  info <- vapour::vapour_raster_info(cog.url)\n  roi <- info$extent\n  prj <- info$projection\n  dim <-  dim\n\n  vals <- vapour::vapour_warp_raster(cog.url, extent = roi, dimension = dim, projection = prj\n                                   , bands = c(1,2,3)\n                                   , band_output_type = \"Int32\"\n                                   , resample = \"Bilinear\")\n  \n  ras <- terra::rast(terra::ext(roi), ncols = dim[1], nrows = dim[2], vals = array(unlist(vals), c(dim, 3)), nlyrs = 3, crs = prj)\n\n  return(ras)\n}\n```\n:::\n\n\nLets get all images for a certain tile and print the acquisition dates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmultitemporal <- dat |> \n  filter(tile_id == \"324965790\")\n\nmultitemporal$Aktualitaet\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"2019-04-07\" \"2022-05-03\"\n```\n:::\n:::\n\n\n#### First image in tile\n\nNow lets query and print the first image for this tile.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg1 <- multitemporal |> \n  slice_min(order_by = date) |> \n  get_img()\n\nterra::plotRGB(img1)\n```\n\n::: {.cell-output-display}\n![First image in tile](orthos_files/figure-html/fig-first-image-multitemporal-1.png){#fig-first-image-multitemporal width=672}\n:::\n:::\n\n\n#### Last image in tile\n\nAnd the last image for this tile.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg2 <- multitemporal |> \n  slice_max(order_by = date) |> \n  get_img()\n\nterra::plotRGB(img2)\n```\n\n::: {.cell-output-display}\n![Last image in tile](orthos_files/figure-html/fig-last-image-multitemporal-1.png){#fig-last-image-multitemporal width=672}\n:::\n:::\n\n\n::: {.callout-warning}\nUntil now you will get a warning `Range downloading not supported by this server!` when trying to use range requests for RGBI data!\n:::\n",
    "supporting": [
      "orthos_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}